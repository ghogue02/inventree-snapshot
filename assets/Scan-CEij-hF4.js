import{j as e}from"./vendor-ui-Cn-AWZmU.js";import{u as X,a as y}from"./vendor-react-BHT4GRGd.js";import{e as V,C as A,d as L,L as Y}from"./client-DgMJTZRL.js";import{a as Z,T as ee,b as se,c as B,d as $}from"./tabs-BKfKmjqt.js";import{u as te}from"./vendor-utils-CbB7EdWd.js";import{a as G,g as ae}from"./productService-BkrJxGhU.js";import{c as ne,u as n,a as H}from"./index-DKYL_AX4.js";import{a as re,p as oe}from"./inventoryService-DdHjgH4d.js";import{B as N}from"./button-DRab5i6-.js";import{L as E,U as Q}from"./upload-CsKrtzVR.js";import{I as ie}from"./input-B9kTI4Cn.js";import{P as K}from"./plus-BapLzJnN.js";import{T as ce}from"./trash-2-HH2kLMFn.js";import{C as de}from"./check-CuDtplOH.js";import"./utils-B-GjzKLI.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=ne("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]),ue=d=>{const f=X(),[g,o]=y.useState(null),[l,v]=y.useState(!1),[a,i]=y.useState(null),[p,u]=y.useState([]),[j,m]=y.useState(!1),[s,r]=y.useState(null),z=async t=>{const h=t||g;if(h){v(!0);try{const c=h.split(",")[1];n.loading("Analyzing image...");const C=await Z(h,"Please analyze this image and identify all food inventory items you see. For each item, include the specific product name, size/volume information, and quantity as individual units.");i(C),n.dismiss(),n.success("Analysis complete");const I=w(C,d);u(I)}catch(c){console.error("Error analyzing image:",c),n.dismiss(),n.error("Failed to analyze image. Please try again or upload a clearer photo."),i(null)}finally{v(!1)}}},w=(t,h)=>{const c=[],C=t.split(`
`);let I="",b="",k=1;for(const x of C){const U=x.match(/size\s*\/?\s*volume:?\s*(.+)/i)||x.match(/([0-9.]+\s*(?:oz|g|ml|L|lb|kg)(?:\s*\(\s*[0-9.]+\s*[a-z]+\s*\))?)/i);U&&(b=U[1].trim());const O=x.match(/product name:?\s*(.+)/i)||x.match(/^[0-9]+\.\s*(.+)/);if(O&&(I=O[1].trim(),!b)){const F=I.match(/([0-9.]+\s*(?:oz|g|ml|L|lb|kg)(?:\s*\(\s*[0-9.]+\s*[a-z]+\s*\))?)/i);F&&(b=F[1].trim())}const q=x.match(/quantity:?\s*(\d+)/i);if(q&&(k=parseInt(q[1],10)),I&&(x.includes("Size/Volume:")||x.includes("Quantity:")||x.trim().length===0||x.includes("No other")||x.includes("visible"))){const F=D(I);c.push({productId:F?.id||"",name:I,count:k||1,confidence:.9,size:b||""}),I="",b="",k=1}}if(I){const x=D(I);c.push({productId:x?.id||"",name:I,count:k,confidence:.9,size:b||""})}return c},S=async()=>{if(!s){n.error("Please select a file first");return}m(!0);try{const t=await oe(s);u(t),i("Video processed successfully. Here are the detected items:")}catch(t){console.error("Error processing video:",t),n.error("Failed to process video")}finally{m(!1)}},R=t=>{r(t)},P=async()=>{if(p.length===0){n.error("No items to save");return}try{n.loading("Saving inventory counts...");const t=p.filter(c=>c.productId).map(c=>({productId:c.productId,count:c.count,countedAt:new Date,countMethod:"video",notes:"Counted via camera scan"}));if(t.length===0){n.dismiss(),n.warning("No valid inventory items to save. Please add products to inventory first.");return}console.log("Attempting to save inventory counts:",t);const h=await re(t);n.dismiss(),n.success("Inventory counts saved successfully"),f("/inventory")}catch(t){console.error("Error saving inventory counts:",t),n.dismiss(),n.error("Failed to save inventory counts: "+(t instanceof Error?t.message:"Unknown error"))}},M=(t,h)=>{const c=[...p];c[t]=h,u(c)},T=t=>{const h=p.filter((c,C)=>C!==t);u(h),n.success("Item removed from list")},_=()=>{o(null),i(null),u([])},J=()=>{g?(sessionStorage.setItem("capturedProductImage",g),f("/add-product?mode=camera")):f("/add-product")},D=t=>{if(!t)return;const h=t.toLowerCase().trim();return d.find(c=>c.name.toLowerCase().trim().includes(h)||h.includes(c.name.toLowerCase().trim()))};return{capturedImage:g,setCapturedImage:o,isAnalyzing:l,analysisResult:a,recognizedItems:p,isUploading:j,resetCapture:_,analyzeImage:z,processVideo:S,saveInventoryCounts:P,updateRecognizedItem:M,removeRecognizedItem:T,goToAddProduct:J,handleFileSelected:R,checkIfItemExists:D,addToInventory:async t=>{try{n.loading(`Adding "${t.name}" to inventory...`);const h=await G({name:t.name,category:"Other",unit:"each",currentStock:t.count,reorderPoint:5,cost:0,size:t.size}),c=p.map(C=>C.name===t.name?{...C,productId:h.id}:C);return u(c),n.dismiss(),n.success(`"${t.name}" added to inventory`),h}catch(h){return console.error("Error adding item to inventory:",h),n.dismiss(),n.error("Failed to add item to inventory"),null}}}},me=({capturedImage:d,onImageCaptured:f,onResetCapture:g,isAnalyzing:o})=>{const l=y.useRef(null),v=y.useRef(null),a=y.useRef(null),[i,p]=y.useState(!1),u=async()=>{try{const s={video:{facingMode:"environment"},audio:!1},r=await navigator.mediaDevices.getUserMedia(s);l.current&&(l.current.srcObject=r,a.current=r,p(!0))}catch(s){console.error("Error starting camera:",s),n.error("Failed to access camera")}},j=()=>{a.current&&(a.current.getTracks().forEach(s=>s.stop()),a.current=null,p(!1))},m=()=>{if(!l.current||!v.current)return;const s=l.current,r=v.current,z=r.getContext("2d");if(!z)return;r.width=s.videoWidth,r.height=s.videoHeight,z.drawImage(s,0,0,r.width,r.height);const w=r.toDataURL("image/jpeg");f(w),j()};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"video-container bg-gray-100 rounded-md",children:[d?e.jsx("img",{src:d,alt:"Captured inventory",className:"w-full h-full object-contain"}):e.jsx("video",{ref:l,autoPlay:!0,playsInline:!0,className:i?"opacity-100":"opacity-0",onLoadedMetadata:()=>{l.current&&(l.current.classList.remove("opacity-0"),l.current.classList.add("opacity-100"))}}),e.jsx("canvas",{ref:v,className:"hidden"})]}),e.jsxs("div",{className:"flex justify-center gap-2",children:[!i&&!d&&e.jsxs(N,{onClick:u,children:[e.jsx(V,{className:"mr-2 h-4 w-4"}),"Start Camera"]}),i&&!d&&e.jsxs(N,{onClick:m,children:[e.jsx(V,{className:"mr-2 h-4 w-4"}),"Capture Image"]}),d&&!o&&e.jsxs(N,{disabled:!0,children:[e.jsx(E,{className:"mr-2 h-4 w-4 animate-spin"}),"Analyzing..."]}),o&&e.jsxs(N,{disabled:!0,children:[e.jsx(E,{className:"mr-2 h-4 w-4 animate-spin"}),"Analyzing..."]})]})]})},pe=({onVideoSelected:d,isProcessing:f,onProcessVideo:g})=>{const[o,l]=y.useState(null),[v,a]=y.useState(!1),i=m=>{if(m.target.files&&m.target.files[0]){const s=m.target.files[0];l(s),d(s)}},p=m=>{if(m.preventDefault(),a(!1),m.dataTransfer.files&&m.dataTransfer.files[0]){const s=m.dataTransfer.files[0];s.type.startsWith("video/")&&(l(s),d(s))}},u=m=>{m.preventDefault(),a(!0)},j=()=>{a(!1)};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:H("border-2 border-dashed rounded-lg p-6 text-center transition-colors",v?"border-primary bg-primary/5":"border-gray-300",o?"border-green-300 bg-green-50":""),onDrop:p,onDragOver:u,onDragLeave:j,children:[e.jsx("input",{type:"file",accept:"video/*",onChange:i,className:"hidden",id:"video-upload"}),e.jsxs("label",{htmlFor:"video-upload",className:"cursor-pointer flex flex-col items-center justify-center gap-2",children:[e.jsx("div",{className:H("p-4 rounded-full",o?"bg-green-100":"bg-gray-100"),children:o?e.jsx(Q,{className:"h-8 w-8 text-green-500"}):e.jsx(V,{className:"h-8 w-8 text-gray-500"})}),e.jsx("span",{className:"text-sm font-medium",children:o?"Video selected":"Click or drag to upload video"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"MP4, MOV, or AVI up to 100MB"})]}),o&&e.jsxs("div",{className:"mt-3 text-sm bg-green-50 p-2 rounded border border-green-200",children:[e.jsxs("div",{className:"font-medium",children:["Selected: ",o.name]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[(o.size/(1024*1024)).toFixed(2)," MB"]})]})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(N,{onClick:g,disabled:!o||f,className:o?"bg-green-600 hover:bg-green-700":"",children:f?e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"mr-2 h-4 w-4 animate-spin"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"mr-2 h-4 w-4"}),"Process Video"]})})})]})},he=({items:d,products:f,onUpdateItem:g,onRemoveItem:o,onAddToInventory:l,checkIfItemExists:v})=>d.length?e.jsx(A,{children:e.jsx(L,{className:"p-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Recognized Items"}),e.jsx("div",{className:"space-y-3",children:d.map((a,i)=>{const p=v(a.name),u=!!p||!!a.productId;return e.jsxs("div",{className:"flex flex-col gap-3 p-2 bg-gray-50 rounded-md",children:[e.jsxs("div",{className:"w-full",children:[e.jsx(ie,{value:a.name,onChange:j=>g(i,{...a,name:j.target.value}),className:"mb-1 w-full min-w-0 break-words"}),e.jsxs("div",{className:"text-sm text-gray-500",children:["Size: ",a.size&&a.size!=="N/A"?a.size:"Not specified"," | Count: ",a.count," | Confidence: ",Math.round(a.confidence*100),"%"]}),p&&e.jsxs("div",{className:"text-sm text-blue-600 mt-1",children:["Matches existing product: ",p.name]})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[!u&&e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>l(a),children:[e.jsx(K,{className:"h-4 w-4 mr-1"}),"Add to Inventory"]}),e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>o(i),children:e.jsx(ce,{className:"h-4 w-4"})})]})]},i)})})]})})}):null,W=({analysisResult:d,recognizedItems:f,products:g,onSaveInventoryCounts:o,onGoToAddProduct:l,onResetCapture:v,onUpdateItem:a,onRemoveItem:i})=>{const[p,u]=y.useState(!1),j=s=>g.find(r=>r.name.toLowerCase()===s.toLowerCase()||r.name.toLowerCase().includes(s.toLowerCase())||s.toLowerCase().includes(r.name.toLowerCase())),m=async s=>{try{u(!0),n.loading(`Adding "${s.name}" to inventory...`);const r=await G({name:s.name,category:"Other",unit:"each",currentStock:s.count,reorderPoint:5,cost:0,size:s.size}),z={...s,productId:r.id},w=f.findIndex(S=>S.name===s.name);return w!==-1&&a(w,z),n.dismiss(),n.success(`"${s.name}" added to inventory`),r}catch(r){return console.error("Error adding item to inventory:",r),n.dismiss(),n.error("Failed to add item to inventory"),null}finally{u(!1)}};return e.jsxs("div",{className:"space-y-4",children:[e.jsx(A,{children:e.jsx(L,{className:"p-4",children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(N,{variant:"outline",size:"sm",onClick:o,children:[e.jsx(de,{className:"h-4 w-4 mr-1"}),"Save Counts"]}),e.jsxs(N,{variant:"outline",size:"sm",onClick:v,children:[e.jsx(le,{className:"h-4 w-4 mr-1"}),"Reset"]}),e.jsxs(N,{variant:"outline",size:"sm",onClick:l,children:[e.jsx(K,{className:"h-4 w-4 mr-1"}),"Add Product"]})]})})}),e.jsx(he,{items:f,products:g,onUpdateItem:a,onRemoveItem:i,onAddToInventory:m,checkIfItemExists:j}),d&&e.jsx(A,{children:e.jsx(L,{className:"p-4",children:e.jsx("pre",{className:"text-xs whitespace-pre-wrap",children:d})})})]})},Pe=()=>{const[d,f]=y.useState("camera"),{data:g=[]}=te({queryKey:["products"],queryFn:ae}),{capturedImage:o,setCapturedImage:l,isAnalyzing:v,analysisResult:a,recognizedItems:i,isUploading:p,resetCapture:u,analyzeImage:j,processVideo:m,saveInventoryCounts:s,updateRecognizedItem:r,removeRecognizedItem:z,goToAddProduct:w,handleFileSelected:S,checkIfItemExists:R,addToInventory:P}=ue(g),M=T=>{l(T),j(T)};return e.jsx(Y,{title:"Scan Inventory",description:"Use your camera to automatically count inventory items",children:e.jsx("div",{className:"p-6",children:e.jsxs(ee,{defaultValue:"camera",value:d,onValueChange:f,children:[e.jsxs(se,{className:"grid w-full grid-cols-2 mb-4",children:[e.jsx(B,{value:"camera",children:"Camera Scan"}),e.jsx(B,{value:"upload",children:"Upload Video"})]}),e.jsxs($,{value:"camera",className:"space-y-4",children:[e.jsx(A,{children:e.jsx(L,{className:"p-6 space-y-4",children:e.jsx(me,{capturedImage:o,onImageCaptured:M,onResetCapture:u,isAnalyzing:v})})}),a&&e.jsx(W,{analysisResult:a,recognizedItems:i,products:g,onSaveInventoryCounts:s,onGoToAddProduct:w,onResetCapture:u,onUpdateItem:r,onRemoveItem:z,onAddToInventory:P,checkIfItemExists:R})]}),e.jsx($,{value:"upload",children:e.jsx(A,{children:e.jsxs(L,{className:"p-6 space-y-4",children:[e.jsx(pe,{onVideoSelected:S,isProcessing:p,onProcessVideo:m}),i.length>0&&e.jsx(W,{analysisResult:a||"",recognizedItems:i,products:g,onSaveInventoryCounts:s,onGoToAddProduct:w,onResetCapture:u,onUpdateItem:r,onRemoveItem:z,onAddToInventory:P,checkIfItemExists:R})]})})})]})})})};export{Pe as default};
//# sourceMappingURL=Scan-CEij-hF4.js.map
